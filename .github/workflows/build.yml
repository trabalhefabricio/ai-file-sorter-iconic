name: Build & Test

on:
  push:
    branches: [ main, dev, newstuff ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # Allow manual trigger

# Minimal permissions for security
permissions:
  contents: read

jobs:
  build-linux:
    name: Build (Ubuntu)
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          host: linux
          target: desktop
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            libcurl4-openssl-dev libjsoncpp-dev libsqlite3-dev \
            libssl-dev libfmt-dev libspdlog-dev libintl-perl gettext

      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: build
          key: cmake-linux-${{ runner.os }}-${{ hashFiles('app/CMakeLists.txt', 'app/**/*.cpp', 'app/**/*.hpp') }}
          restore-keys: |
            cmake-linux-${{ runner.os }}-

      - name: Configure CMake
        run: |
          cmake -S app -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DAI_FILE_SORTER_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Unit Tests
        run: |
          cd build
          ctest --output-on-failure --verbose
          
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: aifilesorter-linux-${{ github.sha }}
          path: build/aifilesorter
          retention-days: 7

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        
      - name: Check for common issues
        run: |
          echo "=== Checking for debug statements ==="
          # Report std::cout statements but don't fail (they may be intentional for CLI output)
          COUT_COUNT=$(grep -rn "std::cout" app/lib/ app/include/ --include="*.cpp" --include="*.hpp" | wc -l)
          if [ "$COUT_COUNT" -gt 0 ]; then
            echo "::warning::Found $COUT_COUNT std::cout statements - review if these are intentional"
            grep -rn "std::cout" app/lib/ app/include/ --include="*.cpp" --include="*.hpp" | head -20
          else
            echo "[OK] No std::cout debug statements found"
          fi
          
          echo ""
          echo "=== Checking for TODO comments ==="
          # Report TODO comments (informational, doesn't fail)
          TODO_COUNT=$(grep -rn "TODO\|FIXME\|HACK\|XXX" app/lib/ app/include/ --include="*.cpp" --include="*.hpp" | wc -l)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "::notice::Found $TODO_COUNT TODO/FIXME comments"
            grep -rn "TODO\|FIXME\|HACK\|XXX" app/lib/ app/include/ --include="*.cpp" --include="*.hpp" | head -20
          else
            echo "[OK] No TODO comments found"
          fi
          
          echo ""
          echo "=== Code quality check complete ==="
